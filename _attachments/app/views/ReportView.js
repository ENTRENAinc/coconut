// Generated by CoffeeScript 1.3.1
var ReportView,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor; child.__super__ = parent.prototype; return child; };

ReportView = (function(_super) {

  __extends(ReportView, _super);

  ReportView.name = 'ReportView';

  function ReportView() {
    this.render = __bind(this.render, this);

    this.update = __bind(this.update, this);
    return ReportView.__super__.constructor.apply(this, arguments);
  }

  ReportView.prototype.initialize = function() {
    return $("html").append("      <link href='js-libraries/Leaflet/leaflet.css' type='text/css' rel='stylesheet' />      <script type='text/javascript' src='js-libraries/Leaflet/leaflet-src.js'></script>      <!--      <script src='../lib/leaflet-dist/leaflet-src.js'></script>      -->      <link rel='stylesheet' href='js-libraries/Leaflet/MarkerCluster.css' />      <link rel='stylesheet' href='js-libraries/Leaflet/MarkerCluster.Default.css' />      <script src='js-libraries/Leaflet/leaflet.markercluster-src.js'></script>      <script src='http://maps.google.com/maps/api/js?v=3.2&sensor=false'></script>	    <script src='js-libraries/Leaflet/leaflet-plugins/layer/tile/Bing.js'></script>      <style>        .cases{          display: none;        }      </style>    ");
  };

  ReportView.prototype.el = '#content';

  ReportView.prototype.events = {
    "change #reportOptions": "update",
    "change #summaryField": "summarize",
    "change #cluster": "update",
    "click .toggleDisaggregation": "toggleDisaggregation"
  };

  ReportView.prototype.hideSublocations = function() {
    var hide;
    console.log("ASA");
    hide = false;
    return _.each(this.locationTypes, function(location) {
      if (hide) {
        $("#row-" + location).hide();
      }
      if ($("#" + location).val() === "ALL") {
        return hide = true;
      }
    });
  };

  ReportView.prototype.update = function() {
    var reportOptions, url;
    reportOptions = {
      startDate: $('#start').val(),
      endDate: $('#end').val(),
      reportType: $('#report-type :selected').text(),
      cluster: $("#cluster").val()
    };
    _.each(this.locationTypes, function(location) {
      return reportOptions[location] = $("#" + location + " :selected").text();
    });
    url = "reports/" + _.map(reportOptions, function(value, key) {
      return "" + key + "/" + (escape(value));
    }).join("/");
    return Coconut.router.navigate(url, true);
  };

  ReportView.prototype.render = function(options) {
    var selectedLocations,
      _this = this;
    this.locationTypes = "region, district, constituan, shehia".split(/, /);
    _.each(this.locationTypes, function(option) {
      if (options[option] === void 0) {
        return this[option] = "ALL";
      } else {
        return this[option] = unescape(options[option]);
      }
    });
    this.reportType = options.reportType || "dashboard";
    this.startDate = options.startDate || moment(new Date).subtract('days', 7).format("YYYY-MM-DD");
    this.endDate = options.endDate || moment(new Date).format("YYYY-MM-DD");
    this.cluster = options.cluster || "off";
    this.$el.html("      <style>        table.results th.header, table.results td{          font-size:150%;        }        .malaria-positive{          background-color: pink;        }      </style>      <table id='reportOptions'></table>      <div id='reportContents'></div>      ");
    $("#reportOptions").append(this.formFilterTemplate({
      id: "start",
      label: "Start Date",
      form: "<input id='start' type='date' value='" + this.startDate + "'/>"
    }));
    $("#reportOptions").append(this.formFilterTemplate({
      id: "end",
      label: "End Date",
      form: "<input id='end' type='date' value='" + this.endDate + "'/>"
    }));
    selectedLocations = {};
    _.each(this.locationTypes, function(locationType) {
      return selectedLocations[locationType] = this[locationType];
    });
    _.each(this.locationTypes, function(locationType, index) {
      var locationSelectedOneLevelHigher;
      return $("#reportOptions").append(_this.formFilterTemplate({
        type: "location",
        id: locationType,
        label: locationType.capitalize(),
        form: "          <select data-role='selector' id='" + locationType + "'>            " + (locationSelectedOneLevelHigher = selectedLocations[_this.locationTypes[index - 1]], _.map(["ALL"].concat(_this.hierarchyOptions(locationType, locationSelectedOneLevelHigher)), function(hierarchyOption) {
          return "<option " + (hierarchyOption === selectedLocations[locationType] ? "selected='true'" : void 0) + ">" + hierarchyOption + "</option>";
        }).join("")) + "          </select>        "
      }));
    });
    this.hideSublocations();
    $("#reportOptions").append(this.formFilterTemplate({
      id: "report-type",
      label: "Report Type",
      form: "      <select data-role='selector' id='report-type'>        " + (_.map(["dashboard", "locations", "spreadsheet", "summarytables"], function(type) {
        return "<option " + (type === _this.reportType ? "selected='true'" : void 0) + ">" + type + "</option>";
      }).join("")) + "      </select>      "
    }));
    this[this.reportType]();
    $('div[data-role=fieldcontain]').fieldcontain();
    $('select[data-role=selector]').selectmenu();
    return $('input[type=date]').datebox({
      mode: "calbox"
    });
  };

  ReportView.prototype.hierarchyOptions = function(locationType, location) {
    if (locationType === "region") {
      return _.keys(WardHierarchy.hierarchy);
    }
    return _.chain(WardHierarchy.hierarchy).map(function(value, key) {
      if (locationType === "district" && location === key) {
        return _.keys(value);
      }
      return _.map(value, function(value, key) {
        if (locationType === "constituan" && location === key) {
          return _.keys(value);
        }
        return _.map(value, function(value, key) {
          if (locationType === "shehia" && location === key) {
            return value;
          }
        });
      });
    }).flatten().compact().value();
  };

  ReportView.prototype.mostSpecificLocationSelected = function() {
    var mostSpecificLocationType, mostSpecificLocationValue;
    mostSpecificLocationType = "region";
    mostSpecificLocationValue = "ALL";
    _.each(this.locationTypes, function(locationType) {
      if (this[locationType] !== "ALL") {
        mostSpecificLocationType = locationType;
        return mostSpecificLocationValue = this[locationType];
      }
    });
    return {
      type: mostSpecificLocationType,
      name: mostSpecificLocationValue
    };
  };

  ReportView.prototype.formFilterTemplate = function(options) {
    return "        <tr id='row-" + options.id + "' class='" + options.type + "'>          <td>            <label style='display:inline' for='" + options.id + "'>" + options.label + "</label>           </td>          <td style='width:150%'>            " + options.form + "          </td>        </tr>    ";
  };

  ReportView.prototype.viewQuery = function(options) {
    var _this = this;
    return $.couch.db(Coconut.config.database_name()).view("zanzibar/caseByLastModified", {
      descending: true,
      include_docs: true,
      startkey: moment(this.endDate).eod().format(Coconut.config.get("date_format")),
      endkey: this.startDate,
      success: function(result) {
        var cases, resultHash;
        resultHash = {};
        _.each(result.rows, function(caseResult) {
          if (!resultHash[caseResult.doc["MalariaCaseID"]]) {
            resultHash[caseResult.doc["MalariaCaseID"]] = [];
          }
          return resultHash[caseResult.doc["MalariaCaseID"]].push(new Result(caseResult.doc));
        });
        cases = _.chain(resultHash).map(function(results, caseID) {
          var malariaCase, mostSpecificLocationSelected;
          malariaCase = new Case({
            results: results
          });
          mostSpecificLocationSelected = _this.mostSpecificLocationSelected();
          if (mostSpecificLocationSelected.name === "ALL" || malariaCase.withinLocation(mostSpecificLocationSelected)) {
            return malariaCase;
          }
        }).compact().value();
        return options.success(cases);
      }
    });
  };

  ReportView.prototype.locations = function() {
    var _this = this;
    $("#reportOptions").append(this.formFilterTemplate({
      id: "cluster",
      label: "Cluster",
      form: "        <select name='cluster' id='cluster' data-role='slider'>          <option value='off'>Off</option>          <option value='on' " + (this.cluster === "on" ? "selected='true'" : '') + "'>On</option>        </select>       "
    }));
    $("#reportContents").html("      Use + - buttons to zoom map. Click and drag to reposition the map. Circles with a darker have multiple cases. Red cases show households with additional positive malaria cases.<br/>      <div id='map' style='width:100%; height:600px;'></div>    ");
    $("#cluster").slider();
    return this.viewQuery({
      success: function(results) {
        var bing, clusterGroup, latitudeSum, locations, longitudeSum, map, osm;
        locations = _.compact(_.map(results, function(caseResult) {
          var _ref, _ref1, _ref2, _ref3;
          if ((_ref = caseResult.Household) != null ? _ref["HouseholdLocation-latitude"] : void 0) {
            return {
              MalariaCaseID: caseResult.caseID,
              latitude: (_ref1 = caseResult.Household) != null ? _ref1["HouseholdLocation-latitude"] : void 0,
              longitude: (_ref2 = caseResult.Household) != null ? _ref2["HouseholdLocation-longitude"] : void 0,
              hasAdditionalPositiveCasesAtHousehold: caseResult.hasAdditionalPositiveCasesAtHousehold(),
              date: (_ref3 = caseResult.Household) != null ? _ref3.lastModifiedAt : void 0
            };
          }
        }));
        if (locations.length === 0) {
          $("#map").html("            <h2>No location information for the range specified.</h2>          ");
          return;
        }
        latitudeSum = _.reduce(locations, function(memo, location) {
          return memo + Number(location.latitude);
        }, 0);
        longitudeSum = _.reduce(locations, function(memo, location) {
          return memo + Number(location.longitude);
        }, 0);
        map = new L.Map('map', {
          center: new L.LatLng(latitudeSum / locations.length, longitudeSum / locations.length),
          zoom: 9
        });
        osm = new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
        bing = new L.BingLayer("Anqm0F_JjIZvT0P3abS6KONpaBaKuTnITRrnYuiJCE0WOhH6ZbE4DzeT6brvKVR5");
        map.addLayer(bing);
        map.addControl(new L.Control.Layers({
          'OSM': osm,
          "Bing": bing
        }, {}));
        L.Icon.Default.imagePath = 'js-libraries/Leaflet/images';
        if (_this.cluster === "on") {
          clusterGroup = new L.MarkerClusterGroup();
          _.each(locations, function(location) {
            return L.marker([location.latitude, location.longitude]).addTo(clusterGroup).bindPopup("" + location.date + ": <a href='#show/case/" + location.MalariaCaseID + "'>" + location.MalariaCaseID + "</a>");
          });
          return map.addLayer(clusterGroup);
        } else {
          return _.each(locations, function(location) {
            return L.circleMarker([location.latitude, location.longitude], {
              "fillColor": location.hasAdditionalPositiveCasesAtHousehold ? "red" : ""
            }).addTo(map).bindPopup("                 " + location.date + ": <a href='#show/case/" + location.MalariaCaseID + "'>" + location.MalariaCaseID + "</a>               ");
          });
        }
      }
    });
  };

  ReportView.prototype.spreadsheet = function() {
    var _this = this;
    return this.viewQuery({
      success: function(cases) {
        var allCasesFlattened, csv, csvData, csvHeaders, fields;
        fields = {};
        csv = {};
        allCasesFlattened = _.map(cases, function(malariaCase) {
          var malariaCaseFlattened;
          malariaCaseFlattened = malariaCase.flatten();
          _.each(_.keys(malariaCaseFlattened), function(field) {
            return fields[field] = true;
          });
          return malariaCaseFlattened;
        });
        csvHeaders = (_.keys(fields)).join(",");
        csvData = _.map(allCasesFlattened, function(malariaCaseFlattened) {
          return _.map(fields, function(value, key) {
            if (!csv[key]) {
              csv[key] = [];
            }
            csv[key].push(malariaCaseFlattened[key] || null);
            return malariaCaseFlattened[key] || null;
          }).join(",");
        }).join("\n");
        $("#reportContents").html("          <a id='csv' href='data:text/octet-stream;base64," + (Base64.encode(csvHeaders + "\n" + csvData)) + "' download='" + (_this.startDate + "-" + _this.endDate) + ".csv'>Download spreadsheet</a>        ");
        return $("a#csv").button();
      }
    });
  };

  ReportView.prototype.results = function() {
    var _this = this;
    $("#reportContents").html("      <table id='results' class='tablesorter'>        <thead>          <tr>          </tr>        </thead>        <tbody>        </tbody>      </table>    ");
    return this.viewQuery({
      success: function(cases) {
        var fields, tableData;
        fields = "MalariaCaseID,LastModifiedAt,Questions".split(",");
        tableData = _.chain(cases).sortBy(function(caseResult) {
          return caseResult.LastModifiedAt();
        }).value().reverse().map(function(caseResult) {
          return _.map(fields, function(field) {
            return caseResult[field]();
          });
        });
        $("table#results thead tr").append("          " + (_.map(fields, function(field) {
          return "<th>" + field + "</th>";
        }).join("")) + "        ");
        return $("table#results tbody").append(_.map(tableData, function(row) {
          return "          <tr>            " + (_.map(row, function(element, index) {
            return "              <td>" + (index === 0 ? "<a href='#show/case/" + element + "'>" + element + "</a>" : element) + "</td>            ";
          }).join("")) + "          </tr>        ";
        }).join(""));
      }
    });
  };

  ReportView.prototype.summarytables = function() {
    var _this = this;
    return Coconut.resultCollection.fetch({
      include_docs: true,
      success: function() {
        var fields;
        fields = _.chain(Coconut.resultCollection.toJSON()).map(function(result) {
          return _.keys(result);
        }).flatten().uniq().sort().value();
        fields = _.without(fields, "_id", "_rev");
        $("#reportContents").html("          <br/>          Choose a field to summarize:<br/>          <select data-role='selector' id='summaryField'>            <option></option>            " + (_.map(fields, function(field) {
          return "<option id='" + field + "'>" + field + "</option>";
        }).join("")) + "          </select>        ");
        return $('#summaryField').selectmenu();
      }
    });
  };

  ReportView.prototype.summarize = function() {
    var field,
      _this = this;
    field = $('#summaryField option:selected').text();
    return this.viewQuery({
      success: function(cases) {
        var results;
        results = {};
        _.each(cases, function(caseData) {
          return _.each(caseData.toJSON(), function(value, key) {
            if (key === "Household Members") {
              return _.each(value, function(value, key) {
                if (value[field] != null) {
                  if (results[value[field]] != null) {
                    results[value[field]]["sums"] += 1;
                    return results[value[field]]["caseIDs"].push(caseData.caseID);
                  } else {
                    results[value[field]] = {};
                    results[value[field]]["sums"] = 1;
                    results[value[field]]["caseIDs"] = [];
                    return results[value[field]]["caseIDs"].push(caseData.caseID);
                  }
                }
              });
            } else if (value[field] != null) {
              if (results[value[field]] != null) {
                results[value[field]]["sums"] += 1;
                return results[value[field]]["caseIDs"].push(caseData.caseID);
              } else {
                results[value[field]] = {};
                results[value[field]]["sums"] = 1;
                results[value[field]]["caseIDs"] = [];
                return results[value[field]]["caseIDs"].push(caseData.caseID);
              }
            }
          });
        });
        if ($("#summaryTables").length !== 1) {
          _this.$el.append("<div id='summaryTables'></div>");
        }
        $("#summaryTables").html("          <h2>" + field + "</h2>          <table id='summaryTable' class='tablesorter'>            <thead>              <tr>                <th>Value</th>                <th>Total</th>                <th class='cases'>Cases</th>              </tr>            </thead>            <tbody>              " + (_.map(results, function(aggregates, value) {
          return "                  <tr>                    <td>" + value + "</td>                    <td>                      <button class='toggleDisaggregation'>" + aggregates["sums"] + "</button>                    </td>                    <td class='cases'>                      " + (_.map(aggregates["caseIDs"], function(caseID) {
            return "<a href='#show/case/" + caseID + "'>" + caseID + "</a>";
          }).join(", ")) + "                    </td>                  </tr>                  ";
        }).join("")) + "            </tbody>          </table>        ");
        $("button").button();
        $("a").button();
        return _.each($('table tr'), function(row, index) {
          if (index % 2 === 1) {
            return $(row).addClass("odd");
          }
        });
      }
    });
  };

  ReportView.prototype.toggleDisaggregation = function(event) {
    return $(event.target).parents("td").siblings(".cases").toggle();
  };

  ReportView.prototype.dashboard = function() {
    var tableColumns,
      _this = this;
    $("tr.location").hide();
    $("#reportContents").html("      <!--      Reported/Facility Followup/Household Followup/#Tested/ (Show for Same period last year)      For completed cases, average time between notification and household followup      Last seven days      Last 30 days      Last 365 days      Current month      Current year      Total      -->      <h1>        Cases      </h2>      The dates for each case result are shown below. Pink buttons are for <span style='background-color:pink'> positive malaria results.</span>      <table class='summary tablesorter'>        <thead><tr>        </tr></thead>        <tbody>        </tbody>      </table>      <style>        table a, table a:link, table a:visited {color: blue; font-size: 150%}      </style>    ");
    tableColumns = ["Case ID", "Health Facility District", "MEEDS Notification"];
    Coconut.questions.fetch({
      success: function() {
        tableColumns = tableColumns.concat(Coconut.questions.map(function(question) {
          return question.label();
        }));
        return _.each(tableColumns, function(text) {
          return $("table.summary thead tr").append("<th>" + text + "</th>");
        });
      }
    });
    return $.couch.db(Coconut.config.database_name()).view("zanzibar/caseIDsByDate", {
      startkey: moment(this.endDate).eod().format(Coconut.config.get("date_format")),
      endkey: this.startDate,
      descending: true,
      include_docs: true,
      success: function(result) {
        var afterRowsAreInserted, caseIds;
        caseIds = _.unique(_.map(result.rows, function(object) {
          return object.value;
        }));
        afterRowsAreInserted = _.after(caseIds.length, function() {
          return $("table.summary").tablesorter({
            widgets: ['zebra'],
            sortList: [[2, 1]]
          });
        });
        return _.each(caseIds, function(caseId) {
          return $.couch.db(Coconut.config.database_name()).view("zanzibar/cases", {
            key: caseId,
            include_docs: true,
            success: function(result) {
              var tableRow;
              tableRow = $("<tr id='case-" + caseId + "'>                " + (_.map(tableColumns, function(type) {
                return "<td class='" + (type.replace(/\ /g, '')) + "'></td>";
              }).join("")) + "                </tr>");
              tableRow.find("td.CaseID").html("<a href='#show/case/" + caseId + "'><button>" + caseId + "</button></a>");
              _.each(result.rows, function(row) {
                var date, linkButton;
                date = row.doc.lastModifiedAt || row.doc.date;
                date = date.substring(0, date.lastIndexOf(":"));
                linkButton = _this.createDashboardLink({
                  caseId: caseId,
                  docId: row.doc._id,
                  buttonClass: (row.doc.MalariaTestResult != null) && (row.doc.MalariaTestResult === "PF" || row.doc.MalariaTestResult === "Mixed") ? "malaria-positive" : "",
                  buttonText: date
                });
                if (row.doc.question != null) {
                  tableRow.find("td." + (row.doc.question.replace(/\ /g, ''))).append(linkButton);
                } else {
                  tableRow.find("td.HealthFacilityDistrict").append(FacilityHierarchy.getDistrict(row.doc.hf));
                  tableRow.find("td.MEEDSNotification").html(linkButton);
                }
                return $("table.summary tbody").append(tableRow);
              });
              return afterRowsAreInserted();
            }
          });
        });
      }
    });
  };

  ReportView.prototype.createDashboardLink = function(options) {
    return "<a href='#show/case/" + options.caseId + "/" + options.docId + "'><button class='" + options.buttonClass + "'>" + options.buttonText + "</button></a>";
  };

  return ReportView;

})(Backbone.View);
