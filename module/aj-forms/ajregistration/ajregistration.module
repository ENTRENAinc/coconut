<?php
include_once 'C32.php';
/**
 * @filesource
 * This is the hook_help implementation
 *
 * @param path
 *   Which path of the site we're using to display help
 * @param arg
 *   Array that holds the current path as returned from arg() function
 */
function ajregistration_help($path, $arg) {
	switch ($path) {
		case "admin/help#ajregistration":
			return '<p>' . t("Implementation of the Registration Form") . '</p>';
			break;
	}
}

/**
 *Implements the hook_menu
 */
 function ajregistration_menu() {
	$items = array();

	$items['ajregistration'] = array(
		'title' => 'Registration form',
		'description' => 'Form to collect data of a new beneficiary',
		'page callback' => '_ajregistration_page',
    	'page arguments' => array('ajregistration_form'),
		'access arguments' => array('access ajregistration content'),
		'type' => MENU_NORMAL_ITEM,
	);

	return $items;
 }

 /**
  *  Page callback: Current users settings
  *  @see current_users_menu()
  */
function ajregistration_form($form, &$form_state) {

	$DirectIndirectOptions = array(
		'No' => t('Directo'),
		'Sí' => t('Indirecto'),
	);

	$form['beneficiary_type'] = array(
		'#type' => 'select',
		'#title' => t(' Tipo de participante: '),
		'#options' => $DirectIndirectOptions,
		'#required' => TRUE,
	);


	$form['registration_date'] = array(
		'#type' => 'date',
		'#title' => t('Fecha de Registro:'),
		'#required' => true,
		'#default_value' =>	array('year' => 1990, 'month' => null, 'day' => null),
	);

	$form['1A'] = array(
		'#type' => 'textfield',
		'#title' => t('1. Nombres: '),
		'#required' => true,
		'#maxlength' => 50,
	);

	$form['1B'] = array(
		'#type' => 'textfield',
		'#title' => t('1. Apellidos:'),
		'#required' => true,
		'#maxlength' => 50,
	);

	$form['1C'] = array(
		'#type' => 'textfield',
		'#title' => t('1. Apodo:'),
		'#required' => true,
		'#maxlength' => 50,
	);

	$form['2A'] = array(
		'#type' => 'textfield',
		'#title' => t('2. Calle y Número:'),
		'#required' => true,
		'#maxlength' => 70,
	);

	$form['2B'] = array(
		'#type' => 'textfield',
		'#title' => t('2. Barrio/Comunidad:'),
		'#required' => true,
		'#maxlength' => 70,
	);

	$form['2C'] = array(
		'#type' => 'textfield',
		'#title' => t('2. Municipio:'),
		'#required' => true,
		'#maxlength' => 70,
	);

	$form['2D'] = array(
		'#type' => 'textfield',
		'#title' => t('2. Provincia:'),
		'#required' => true,
		'#maxlength' => 70,
	);

	$form['3'] = array(
		'#type' => 'date',
		'#title' => t('3. Fecha de nacimiento:'),
		'#required' => true,
		'#default_value' =>	array('year' => 1980, 'month' => null, 'day' => null),
	);

	$ForthOptions = array(
		'F' => t('Femenino'),
		'M' => t('Masculino'),
	);

	$form['4'] = array(
		'#type' => 'select',
		'#title' => t('4. Sexo: '),
		'#options' => $ForthOptions,
		'#required' => TRUE,
	);

	$YesNoOptions = array(
		1 => t('Sí'),
		2 => t('No'),
	);

	$form['5A'] = array(
		'#type' => 'select',
		'#title' => t('5. ¿Tienes Teléfono Celular? '),
		'#options' => drupal_map_assoc($YesNoOptions),
		'#required' => TRUE,
	);

	$form['5A_1'] = array(
		'#type' => 'textfield',
		'#title' => t('5. Teléfono Celular:'),
		'#description' => t('Ej. 809-765-4321. Sólo números 809, 829 y 849 están permitidos'),
		'#required' => false,
		'#maxlength' => 50,
		'#states' => array(
      		'visible' => array(
        		'select[name="5A"]' => array('value' => 'Sí' ),
      			),
    		),
	);

	$form['5B'] = array(
		'#type' => 'select',
		'#title' => t('5. ¿Tienes Teléfono de Casa? '),
		'#options' => drupal_map_assoc($YesNoOptions),
		'#required' => TRUE,
	);

	$form['5B_1'] = array(
		'#type' => 'textfield',
		'#title' => t('5. Teléfono Casa:'),
		'#description' => t('Ej. 809-765-4321. Sólo números 809, 829 y 849 están permitidos'),
		'#required' => false,
		'#maxlength' => 50,
		'#states' => array(
      		'visible' => array(
        		'select[name="5B"]' => array('value' => 'Sí'),
      			),
    		),
	);

	$form['6'] = array(
		'#type' => 'select',
		'#title' => t('6. ¿Tienes Correo Electrónico? '),
		'#options' => drupal_map_assoc($YesNoOptions),
		'#required' => TRUE,
	);

	$form['6A'] = array(
		'#type' => 'textfield',
		'#title' => t('6. Correo electrónico:'),
		'#required' => false,
		'#maxlength' => 50,
		'#states' => array(
      		'visible' => array(
        		'select[name="6"]' => array('value' => 'Sí'),
      			),
    		),
	);

	$form['7'] = array(
		'#type' => 'select',
		'#title' => t('7. ¿Tienes Usuario de Facebook? '),
		'#options' => drupal_map_assoc($YesNoOptions),
		'#required' => TRUE,
	);

	$form['7A'] = array(
		'#type' => 'textfield',
		'#title' => t('7. Usuario de Facebook:'),
		'#required' => false,
		'#maxlength' => 50,
		'#states' => array(
      		'visible' => array(
        		'select[name="7"]' => array('value' => 'Sí'),
      			),
    		),
	);

	$form['8'] = array(
	  '#markup' => '<p><b>8. En caso de no poder localizarte, ¿a quién podemos contactar? </b></p>'
	);

	$form['8A'] = array(
		'#type' => 'textfield',
		'#title' => t('8. Nombre de la persona de contacto:'),
		'#required' => false,
		'#maxlength' => 50,
	);

	$form['8B'] = array(
		'#type' => 'textfield',
		'#title' => t('8. Parentesco o persona relacionada:'),
		'#required' => false,
		'#maxlength' => 50,
	);

	$form['8C'] = array(
		'#type' => 'textfield',
		'#title' => t('8. Teléfono de la persona de contacto:'),
		'#description' => t('Ej. 809-765-4321. Sólo números 809, 829 y 849 están permitidos'),
		'#required' => false,
		'#maxlength' => 50,
	);

	$form['exit']['submit'] = array(
		'#type' => 'submit',
		'#value' => t('Submit'),
		'#weight' => 100,
	);

	return $form;
}

/**
 * This is the hook implementation for _form_submit
 * @param unknown $form
 * @param unknown $form_state
 */
function ajregistration_form_submit($form, &$form_state) {

	$possibleDuplicate = _ajregistration_possibleDuplicate(
			$form_state['values']['1A'],
			$form_state['values']['1B'],
			$form_state['values']['3']
			);

	if(empty($possibleDuplicate)) {
		$provider_id = _ajregistration_getProviderId();
// 		watchdog('claudia', $provider_id);
		$newUUID = _ajregistration_getUUID();
// 		watchdog('claudia', $newUUID);
 		$_regDate = $form_state['values']['registration_date'];
   		 $_regDateString = $_regDate['year'].'-'. (strlen($_regDate['month']) === 1? '0'.$_regDate['month']:$_regDate['month']).'-'.(strlen($_regDate['day']) === 1? '0'.$_regDate['day']:$_regDate['day']);
		_ajregistration_insert_data(
			$form_state['values']['beneficiary_type'],
			$_regDateString,
			$form_state['values']['1A'],
			$form_state['values']['1B'],
			$form_state['values']['1C'],
			$form_state['values']['2A'],
			$form_state['values']['2B'],
			$form_state['values']['2C'],
			$form_state['values']['2D'],
			$form_state['values']['3'],
			$form_state['values']['4'],
			$form_state['values']['5A'],
			$form_state['values']['5A_1'],
			$form_state['values']['5B'],
			$form_state['values']['5B_1'],
			$form_state['values']['6'],
			$form_state['values']['6A'],
			$form_state['values']['7'],
			$form_state['values']['7A'],
			$form_state['values']['8A'],
			$form_state['values']['8B'],
			$form_state['values']['8C'],
			$newUUID,
			$provider_id);
		$beneficiaryDetails = $form_state['values']['1A'].' '.$form_state['values']['1B'].'(UUID='.$newUUID.')';
		drupal_set_message(t('El nuevo beneficiario fue creado satisfactoriamente: '.$beneficiaryDetails.'!'));
		$form_state['redirect'] = 'mis-beneficiarios';
	} else {
		$allDuplicates = '';
		foreach ($possibleDuplicate as $uuid => $entry) {
			$allDuplicates = $allDuplicates . ' '. $entry->nombre . ' ' . $entry->apellido . ' ' . $entry->dob . ' ('. $uuid.'). ';
		}
		drupal_set_message(t('Beneficiario *NO* creado. Existe al menos un beneficiario con similar nombre, apellido y fecha de nacimiento: '.$allDuplicates), 'error');
		$form_state['redirect'] = 'mis-beneficiarios';
	}

}

/**
 *	Implements validation from the Form API.
 *
 * @param $form
 *   A structured array containing the elements and properties of the form.
 * @param $form_state
 *   An array that stores information about the form's current state
 *   during processing.
 */
 function ajregistration_form_validate($form, &$form_state) {

 	$_regDate = $form_state['values']['registration_date'];
    $_regDateString = $_regDate['year'].'-'. (strlen($_regDate['month']) === 1? '0'.$_regDate['month']:$_regDate['month']).'-'.(strlen($_regDate['day']) === 1? '0'.$_regDate['day']:$_regDate['day']);
    $_1A = $form_state['values']['1A'];
    $_1B = $form_state['values']['1B'];
 	$_1C = $form_state['values']['1C'];
    $_2A = $form_state['values']['2A'];
    $_2B = $form_state['values']['2B'];
 	$_2C = $form_state['values']['2C'];
    $_2D = $form_state['values']['2D'];
 	$_3 = $form_state['values']['3'];
    $_3date = $_3['year'].'-'. (strlen($_3['month']) === 1? '0'.$_3['month']:$_3['month']).'-'.(strlen($_3['day']) === 1? '0'.$_3['day']:$_3['day']);
    $_4 = $form_state['values']['4'];
    $_5A = $form_state['values']['5A'];
 	$_5A_1 = $form_state['values']['5A_1'];
 	$_5B = $form_state['values']['5B'];
 	$_5B_1 = $form_state['values']['5B_1'];
 	$_6 = $form_state['values']['6'];
 	$_6A = $form_state['values']['6A'];
 	$_7 = $form_state['values']['7'];
 	$_7A = $form_state['values']['7A'];
 	$_8A = $form_state['values']['8A'];
 	$_8B = $form_state['values']['8B'];
 	$_8C = $form_state['values']['8C'];

	$now = date('Y-m-d', time());
	$phoneNumberPattern = '/^\(?(809|849|829)\)?([ .-]?)([0-9]{3})\2([0-9]{4})$/'; // [0-9]{3}
	$emailPattern = '/^(?!(?:(?:\x22?\x5C[\x00-\x7E]\x22?)|(?:\x22?[^\x5C\x22]\x22?)){255,})(?!(?:(?:\x22?\x5C[\x00-\x7E]\x22?)|(?:\x22?[^\x5C\x22]\x22?)){65,}@)(?:(?:[\x21\x23-\x27\x2A\x2B\x2D\x2F-\x39\x3D\x3F\x5E-\x7E]+)|(?:\x22(?:[\x01-\x08\x0B\x0C\x0E-\x1F\x21\x23-\x5B\x5D-\x7F]|(?:\x5C[\x00-\x7F]))*\x22))(?:\.(?:(?:[\x21\x23-\x27\x2A\x2B\x2D\x2F-\x39\x3D\x3F\x5E-\x7E]+)|(?:\x22(?:[\x01-\x08\x0B\x0C\x0E-\x1F\x21\x23-\x5B\x5D-\x7F]|(?:\x5C[\x00-\x7F]))*\x22)))*@(?:(?:(?!.*[^.]{64,})(?:(?:(?:xn--)?[a-z0-9]+(?:-[a-z0-9]+)*\.){1,126}){1,}(?:(?:[a-z][a-z0-9]*)|(?:(?:xn--)[a-z0-9]+))(?:-[a-z0-9]+)*)|(?:\[(?:(?:IPv6:(?:(?:[a-f0-9]{1,4}(?::[a-f0-9]{1,4}){7})|(?:(?!(?:.*[a-f0-9][:\]]){7,})(?:[a-f0-9]{1,4}(?::[a-f0-9]{1,4}){0,5})?::(?:[a-f0-9]{1,4}(?::[a-f0-9]{1,4}){0,5})?)))|(?:(?:IPv6:(?:(?:[a-f0-9]{1,4}(?::[a-f0-9]{1,4}){5}:)|(?:(?!(?:.*[a-f0-9]:){5,})(?:[a-f0-9]{1,4}(?::[a-f0-9]{1,4}){0,3})?::(?:[a-f0-9]{1,4}(?::[a-f0-9]{1,4}){0,3}:)?)))?(?:(?:25[0-5])|(?:2[0-4][0-9])|(?:1[0-9]{2})|(?:[1-9]?[0-9]))(?:\.(?:(?:25[0-5])|(?:2[0-4][0-9])|(?:1[0-9]{2})|(?:[1-9]?[0-9]))){3}))\]))$/iD';

 	// QUESTION registration_date -------------------------------------------------------------------------------------
	// Check if the date is empty
 	if (empty($_regDateString)) {
		form_error($form['registration_date'], t('Fecha de Registro: Estos campos son requeridos'));
	}
	// Check if date is no later than today
	if (is_string($_regDateString) && strncmp($_regDateString, $now, 10) > 0 ) {
		form_error($form['registration_date'], t('Fecha de Registro: Fecha no puede ser después del día de hoy'));
	}
 	// Check if the date is valid and has the right format
	if (is_string($_regDateString) && strtotime($_regDateString) === FALSE || ((int)$_regDate['year']) < 2012) {
		form_error($form['registration_date'], t('Fecha de Registro: Fecha no válida'));
	}

  	// QUESTION 3 -------------------------------------------------------------------------------------
	// Check if the date is empty
 	if (empty($_3date)) {
		form_error($form['3'], t('3. Fecha de Nacimiento: Estos campos son requeridos'));
	}
 	// Check if the date is valid and has the right format
	if (is_string($_3date) && strtotime($_3date) === FALSE || !_ajregistration_between11And21($_3date)) {
		form_error($form['3'], t('3. Fecha de Nacimiento: Fecha no válida. Edad debe ser entre 11 y 21 años'));
	}

	// QUESTION 5A --------------------------------------------------------------
	if($_5A === 'Sí') {
	 	if (empty($_5A_1)) {
			form_error($form['5A_1'], t('5. Teléfono Celular: Campo obligatorio'));
		} else if (!preg_match($phoneNumberPattern, $_5A_1) || preg_match($phoneNumberPattern, $_5A_1) == 0) {
			form_error($form['5A_1'], t('5. Teléfono Celular: Número de Teléfono no válido'));
		}
	}

 	// QUESTION 5B --------------------------------------------------------------
	if($_5B === 'Sí') {
	 	if (empty($_5B_1)) {
			form_error($form['5B_1'], t('5. Teléfono Casa: Campo obligatorio'));
		} else if (!preg_match($phoneNumberPattern, $_5B_1) || preg_match($phoneNumberPattern, $_5B_1) == 0) {
			form_error($form['5B_1'], t('5. Teléfono Casa: Número de Teléfono no válido'));
		}
	}

  	// QUESTION 6 --------------------------------------------------------------
	if($_6 === 'Sí') {
	 	if (empty($_6A)) {
			form_error($form['6A'], t('6. Correo electrónico: Campo obligatorio'));
		} else if (!preg_match($emailPattern, $_6A) || preg_match($emailPattern, $_6A) == 0) {
			form_error($form['6A'], t('6. Correo electrónico: Correo no válido'));
		}
	}

   	// QUESTION 7 --------------------------------------------------------------
	if($_7 === 'Sí') {
	 	if (empty($_7A)) {
			form_error($form['7A'], t('7.  Usuario de Facebook: Campo obligatorio'));
		}
	}

  	// QUESTION 8 --------------------------------------------------------------
	 if (!empty($_8C)) {
	 	if (!preg_match($phoneNumberPattern, $_8C) || preg_match($phoneNumberPattern, $_8C) == 0)
			form_error($form['8C'], t('8. Teléfono de la persona de contacto: Número de Teléfono no válido'));
	}
 }


 /**
  * Implements the hook_permissions
  */
 function ajregistration_permission() {
	return array(
		'access ajregistration content' => array(
				'title' => t('Access content for ajregistration module'),
				'description' => t('Control the access for the Registration form'),
		)
	);
 }


 /**
  *  Callback function that generates content
  */
function _ajregistration_page() {
	return drupal_get_form('ajregistration_form');
}

/**
 * Script to insert the new form data
 */
function _ajregistration_insert_data(
			$beneficiary_type,
			$_regDateString,
			$_1A,
			$_1B,
			$_1C,
			$_2A,
			$_2B,
			$_2C,
			$_2D,
			$_3,
			$_4,
			$_5A,
			$_5A_1,
			$_5B,
			$_5B_1,
			$_6,
			$_6A,
			$_7,
			$_7A,
			$_8A,
			$_8B,
			$_8C,
			$uuid,
			$provider_id) {
	global $user;
	$currentDate = format_date(time(), 'custom', 'Y-m-d H:i:s');

	$tableFields =  array(
 		'createdAt' => $currentDate,
 		'lastModifiedAt' => $currentDate,
		'provider_id' => $provider_id,
		'user_name' => $user->name,
		'uuid' => $uuid,
		'created' => $currentDate,
		'Fecha' => $_regDateString,
		'nombre' => $_1A,
		'Apellido' => $_1B,
		'Apodo' => $_1C,
		'Calleynumero' => $_2A,
		'BarrioComunidad' => $_2B,
		'Municipio' => $_2C,
		'Provincia' => $_2D,
		'Día' => $_3['day'],
		'Mes' => $_3['month'],
		'año' => $_3['year'],
		'DOB' => ($_3['year'].'-'.$_3['month'].'-'.$_3['day']),
		'Sexo' => $_4,
		'casa' => $_5B_1,
		'celular' => $_5A_1,
		'Direccióndecorreoelectrónico' => $_6A,
		'NombredeusuariodeFacebook' => $_7A,
		'Nombredepersonadecontacto' => $_8A,
		'Parentescoopersonarelacionada' => $_8B,
		'Teléfono' => $_8C,
		'Estecolateralparticipante' => $beneficiary_type,
		'Tieneunnumerodetelefonoenlacasa' => $_5B,
		'Tieneunnumerocelular' => $_5A,
		'Tieneunadireccióndecorreoelectrónico' => $_6,
		'TieneunnombredeusuariodeFacebook' => $_7,
	);

	$new_beneficiary = db_insert('aj_registration')
	->fields($tableFields);
	$new_beneficiary->execute();
}


/**
 * Get the beneficiary info
 */
function _ajregistration_getBeneficiaryInfo($uuid) {

	$query = db_select('aj_registration', 'reg');
	$query->fields('reg', array('nombre'));
	$query->fields('reg', array('apellido'));
	$query->fields('reg', array('uuid'));
	$query->condition('uuid', $uuid);
	$query->orderBy('nombre', 'ASC');
	$query->range(0,1);

	$result = $query->execute();
	return $result->fetchAssoc();
}

/**
 * Checks if a beneficiary is a possible duplicate
 */
function _ajregistration_possibleDuplicate($names, $lastname, $dateOfBirth) {

// 	$query = db_select('aj_registration', 'ajregistration');
// 	$query->fields('ajregistration', array('uuid', 'nombre', 'apellido'));
// 	$query->condition('nombre', '%' . db_like($names) . '%', 'LIKE');
// 	$query->condition('apellido', '%' . db_like($lastname) . '%', 'LIKE');
// 	$query->condition('año', '%' . db_like($dateOfBirth['year']) . '%', 'LIKE');
// 	$query->condition('mes', '%' . db_like($dateOfBirth['month']) . '%', 'LIKE');
// 	$query->condition('día', '%' . db_like($dateOfBirth['day']) . '%', 'LIKE');

	$query = db_query(
			'SELECT uuid, nombre, apellido, dob
			FROM {aj_registration}
			WHERE año = :year and mes = :month and día = :day
			and nombre like :name and apellido like :lastname',
			array(':year' => ($dateOfBirth['year']),
				  ':month' => ($dateOfBirth['month']),
				  ':day' => ($dateOfBirth['day']),
				  ':name' => ('%'.$names.'%'),
				  ':lastname' => ('%'.$lastname.'%'),
			)
			);
	//$query->range(0,1);
// 	watchdog('Claudia', $query);
// 	$result = $query->execute();
	$entry =  $query->fetchAllAssoc('uuid');
// 	var_dump($entry);
// 	watchdog('Claudia', implode(', ', $entry));
	return $entry;
}

/**
 * Checks if the year corresponds
 * @param unknown $yearOfBirth
 */
function _ajregistration_between11And21($dateOfBirth) {
	$now = new DateTime(date('Y-m-d', time()));
	$dateOfBirthObject = new DateTime($dateOfBirth);
	$interval = $now->diff($dateOfBirthObject);
	return ((int)$interval->format('%Y') >= 11 && (int)$interval->format('%Y') <= 21);
}

/**
 * Return the current provider ID based on current user
 * @return unknown
 */
function _ajregistration_getProviderId() {
	global $user;

	$providerID = db_query(
			'SELECT field_user_provider_target_id
			FROM {field_revision_field_user_provider}
			WHERE entity_id = :uid', array(':uid' => $user->uid))->fetchField(0);
	return $providerID;
}

function _ajregistration_getUUID() {
	 $c = new C32();
     $c->getRandom(8);
     $c->addChecksum();
     while(db_query('SELECT uuid FROM {aj_registration} WHERE uuid = :uuid', array(':uuid' => ($c->value)))->rowCount() != 0) {
		$c = new C32();
     	$c->getRandom(8);
     	$c->addChecksum();
     }
     return $c->value;
}
